#!/bin/bash

# EKS Cluster Health Check Script
# Usage: ./cluster-health-check.sh [--wait]

LOG_FILE="{{ log_dir }}/eks_health_$(date +%Y%m%d-%H%M).txt"
HEALTH_FILE="{{ k8s_dir }}/cluster_health.json"
WAIT_MODE=0

# Check for wait flag
if [[ "$1" == "--wait" ]]; then
  WAIT_MODE=1
  echo "Running in wait mode - will wait until cluster is active" | tee $LOG_FILE
else
  echo "Running in check mode - will report current status" | tee $LOG_FILE
fi

# Function to check cluster status
check_cluster_status() {
  echo "Checking EKS cluster status..." | tee -a $LOG_FILE
  
  # Get cluster status
  CLUSTER_STATUS=$(aws eks describe-cluster \
    --name {{ cluster_name }} \
    --region {{ aws_region }} \
    --query "cluster.status" \
    --output text 2>/dev/null)
  
  # Get cluster endpoint
  CLUSTER_ENDPOINT=$(aws eks describe-cluster \
    --name {{ cluster_name }} \
    --region {{ aws_region }} \
    --query "cluster.endpoint" \
    --output text 2>/dev/null)
    
  if [ -z "$CLUSTER_STATUS" ]; then
    CLUSTER_STATUS="UNKNOWN"
  fi
  
  # Update health file
  cat > $HEALTH_FILE << EOF
{
  "cluster_name": "{{ cluster_name }}",
  "status": "$CLUSTER_STATUS",
  "endpoint": "$CLUSTER_ENDPOINT",
  "last_check": "$(date -Iseconds)",
  "deployment_ready": $([ "$CLUSTER_STATUS" == "ACTIVE" ] && echo "true" || echo "false")
}
EOF

  echo "Current cluster status: $CLUSTER_STATUS" | tee -a $LOG_FILE
  
  if [ "$CLUSTER_STATUS" == "ACTIVE" ]; then
    return 0
  else
    return 1
  fi
}

# Main logic
if [ $WAIT_MODE -eq 1 ]; then
  # Wait mode - keep checking until active
  ATTEMPT=1
  MAX_ATTEMPTS=30
  SLEEP_TIME=60
  
  while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
    echo "Attempt $ATTEMPT of $MAX_ATTEMPTS" | tee -a $LOG_FILE
    
    if check_cluster_status; then
      echo "Cluster is now ACTIVE!" | tee -a $LOG_FILE
      exit 0
    fi
    
    echo "Waiting $SLEEP_TIME seconds before next check..." | tee -a $LOG_FILE
    sleep $SLEEP_TIME
    ATTEMPT=$((ATTEMPT+1))
  done
  
  echo "Cluster did not become active within max attempts" | tee -a $LOG_FILE
  exit 1
else
  # Check mode - just report status
  check_cluster_status
  if [ "$CLUSTER_STATUS" == "ACTIVE" ]; then
    echo "Cluster is ACTIVE" | tee -a $LOG_FILE
    exit 0
  else
    echo "Cluster is not active (status: $CLUSTER_STATUS)" | tee -a $LOG_FILE
    exit 1
  fi
fi
